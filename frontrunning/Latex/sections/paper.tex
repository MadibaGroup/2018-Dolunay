% !TEX root = ../main.tex

\section{Introduction}

% PAPER BEING SOLD HERE
% @mahsa summary of `What is frontrunning?` in 2 sentenses, frontrunning in blockchain and why is this important to consider in blockchain/dapp design
% require more indepth academic look into the issue



\section{Preliminary}

\subsection{What is frontrunning?} %Definition of frontrunning

\emph{Front-running} is analogous to any course of action during which a person benefits from prior access to inside or confidential market information to upcoming transactions and trades. This problem can occur in both financial and non-financial systems, however, it is more noticeable within the trading and exchange systems as it was originated back in stock markets. In the old times, all the trades were executed on papers, so in case of receiving a large order from a client, the broker might say this loud and other people around the table could be informed. Therefore, a malicious trader would now run in front of that order and put his own transaction in between (before the trade was executed) and profit from the price increase of the stock. In other words, a group of market participants obtain non-public market information which allows them to front-run other users trades by putting their orders a head of those trades and benefit from advance knowledge of pending client orders. The two significant factors which cause the front-running practice to happen within the financial markets are (i) imperfect competition and (ii) liquidity uncertainty. \textbf{should I explain more?!} Any sort of front-running activity within the financial markets is considered as an illegal practice.


%%%%%%SHOULD WE KEEP THE FOLLOWINGS?%%%%%%
%~\cite{liang2005distressed} : talks about front running in illiquid markets (contains lots of useful definitions of frontrunning to talk about in this section)
%~\cite{sannikov2016dynamic}


% [optional but interesting] Here we can talk about Principal–agent problem: https://en.wikipedia.org/wiki/Principal%E2%80%93agent_problem
% ticket scalping : https://en.wikipedia.org/wiki/Ticket_resale

%______________________________________________________________%

\subsection{Historical Context}
Frontrunning was first appeared on the Chicago Board Options Exchange (SBOE) ~\cite{markham1988front}, and was later defined by \textit{Secrities Exchange Comission} in 1977 as following:
\begin{quote}
The practice of effecting an options transaction based upon non-public information regarding an impending block transaction\footnote{Block in the stock market is large number of shares, 10\,000 or more, to sell which will heavily changes the price} in the underlying stock, in order to obtain a profit when the options market adjusts to the price at which the block trades. ~\cite{sec1978cboe}
\end{quote} 

%In actuality, front-running is more complex than this definition suggests. It encompasses at least three forms of conduct, each of which raises different regulatory and policy issues.9 They are: (1) trading by third parties who are tipped on an impending block trade ("tippee" trading); (2) transactions in which the owner or purchaser of the block trade itself engages in the offset- ting futures or options transaction as a means of "hedging" against price fluctuations caused by the block transaction ("self-front-running"); 1 ° and (3) transactions where a broker with knowledge of an impending customer block order trades ahead of that order for the broker's own profit ("trading ahead").
% from JerryWMarkhamFrontRunning.pdf

% More to read and add from : SECURITIES AND EXCHANGE COMMISSION Release No. 34-67079. pdf included in Related_Documents
% https://www.sec.gov/about/annual_report/1988.pdf


On the years after there were ongoing discussions between self-regulatory exchanges and SEC to regulate, detect and define laws to deal with frontrunning~\cite{markham1988front}, with SEC stating: 
\begin{quote}
it seems evident that such behaviour on the part of persons with knowledge of imminent transactions which will likely affect the price of the derivative security constitutes an unfair use of such knowledge. \footnote{Securities Exchange Act Release No. 14156, November 19, 1977, (Letter from George A. Fitzsimmons, Secretary, Securities and Exchange Commission to Joseph W. Sullivan, President  CBOE).}
\end{quote} 
% http://3197d6d14b5f19f2f440-5e13d29c4c016cf96cbbfd197c579b45.r81.cf1.rackcdn.com/collection/papers/1970/1978_OptMkt_06_Chapter_III_3.pdf
Initially the frontrunning policies only applied to certain options, later on in 2002, the rule was refined to include the same prohibitions to security futures~\cite{sec2012frontrunning}.

%@shayan complete the historical context




\subsection{Frontrunning in Blockchains}: One of the main discussion regarding regulations for exchanges on the topic of frontrunning, comes from the fact that information access is layered and some could be accessed only by insider actors, such as the broker, the IT administrator, \etc. In the blockchain world, everyone running a node of one blockchain could potentially have access to such information, hence it makes it is more susceptible for any actor to engage in frontrunning within applications running on the blockchain. Some other key differences are the fact that such actor can stay anonymous and also enforcing regulation is infeasible in traditional sense, however the decentral application could be designed in such a way to prevent frontrunning attacks. 



\subsection{Related Work}

~\cite{malinova2017market}
~\cite{aune2017footprints}



% Shayan: talk about frontrunning in other blockchains, such as privacy preserving blockchains --> no transparency less chance of frontrunning?  
% this is a big problem with Dapps, what other blockchains support smart contracts that have this problem.


% Mahsa: talk about namecoin frontrunning from the paper




% NOTE: use double-spend paper (first)
% talk about double-spend one kind of frontrunning (relationship between frontrunning vs double spend) rushing actors. 
% Double-spending fast payments in bitcoin.pdf






% = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = =

% = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = =




% = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = =

\section{Frontrunning Attacks in Blockchain}

\subsection{Financial Markets}
%orders, exchanges
% @shayan: front runnign attacks on 0x and etherdelta . if one past one found add it to Implications!
% http://hackingdistributed.com/2017/08/13/cost-of-decent/




\subsection{Non-financial Applications}
Applications, Ghazal, register domains before the user, (domain squatting?) \par\noindent
Other applications (look at Dapps or other blockchain use cases)\par\noindent
Arbitrage (buy before the order, sell to the original order) (other scenarios)\par\noindent
Maker griefing (attack on the system?s reputation itself)\par\noindent
Etherdelta case: Fill the order when cancelling transaction is sent. What would be the profitable scenario here?

% maybe inlcude 0xbitcoin ERC721 mineable tokens frontrunning!
% mint: https://etherscan.io/tx/0x9883bc3ad018fd2b649982f88fbad7dc5abcb8f11c4f1d87ef814ba30c2b3428


%NOTE: top 10 dapps, talk about frontrunning attacks on them. 

% @Mahsa: some interesting read (check out the references) for domain name front running : https://en.wikipedia.org/wiki/Domain_name_front_running

% = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = =


\section{Potential Front runners} % Who and How. 

%WRT blockchain and decentralization

% TALK ABOUT IT {Miners and their power}

%Transaction order, can be used for frontrunning


\subsection{Miners}
%Miners in Bitcoin can do selfish mining and such but in theory
% here we talk about miners actually being malicious(?) to profit themselves. 
%You can do the same thing on the blockchain. If a miner or user sees an unconfirmed transaction in the mempool they could squeeze their own transaction to come in front and profit from that. Essentially, profitting from reordering the transactions.
% Miners can only frontrun in blocks they themselves happen to mine.
% Mining blocks hence order of the transactions within a block --> reorder
% 

% Use example of the paper, talk about status ICO or some other miner reorder frontrunning


\subsection{non-miner}
% Use high gasprice to get infront
% Sybil attacks?
% 

% Use example of  namecoin/domain . use an example of Alice wants to register a domain and bob uses GasPrice to get in front of Alice. 




\section{Implications} %change this to something else

\subsection{Historical evidence of such attacks:}\par\noindent
There has been many incidents of frontrunning in real world blockchains specially where it facilitates monetary gain. Here we will analyze the evidence of these incidents:

% NOTE: This seperation can also happen by another category, like: frontrunning by miners: status ico F2pool, and frontrunning by others

% ICOs and ceiling
% hard cap --> frontrun and buy the tokens in big chunk
% dynamic ceiling, fair token distribution --> status ICO



\subsubsection{Status ICO}
ICO, Initial Coin Offering, is one of the blockchain applications, specially blockchains such as Ethereum with smart contract capability. The common practice is to deploy a smart contract on the blockchain indicating the details of the ICO such as the trade ratio, when it starts and ends, and more details on how it will be capped.
In June 2017, Status.im started their ICO and within 3 hours they reached the dynamic ceiling in place that triggered the end of the ICO, summing in 300,000 ether in funds, estimated at more than 200 million dollars at the time of their ICO. ~\cite{statusicoanalysis}. The idea behind Dynamic Ceilings is to make it more costly for larger contributors,  in the form of transaction fees, which have to split their contributions to different addresses, with minimal impact to smaller contributors~\cite{statuswhitepaper}.
On the time of the ICO there were reports of Ethereum network being unusable and transactions were not confirming. Further study showed that some mining pools (\todo: define mining pool) could have been manipulating the network for their own profit.

%@shayan: make charts and figure out the orange seller

%NOTE: ICO Initial Coin Offering should be explained probably in introduction section. the process of ICO smart contract and how the capped system works --> limited time/funds can be included in the ico and why people would try to get in as soon as possible, explain how their investment strategy works and such. Maybe the second half could be explained here to say why frontrunning an ICO makes sense?
% add more on capped ICOs, status used Distribution & Dynamic Ceilings : https://blog.status.im/distribution-dynamic-ceilings-e2f427f5cca  ~\cite{statuswhitepaper}

% The dynamic ceiling and prevention of bigger investments getting their full investment in could be the reason behind the design of F2pool move, by having multiple addresses each contributing around 100ETH to the ICO smart contract, instead of having one big transaction in.
%Also the ICO smart contract only accepted transactions with gas price lower than 50gwei, unless they were whitelisted before. this was for preventing high gas payers to get in front of the line. although as this was not clearly communicated to users (UX issues?), there were tons of transactions that failed due to high gas price but also clogged the ethereum network as the miners chose transactions with higher gas price to be included in their blocks.


% weird findings: apparently all the tokens bought by f2pool was transfered to Yunbi, the chinese exchange: 0xB6c3647F55085B9a327404Fe8B718076Ee19245a

% Proof of f2pool involvement: https://etherscan.io/address/0x5fb8373bf5086fb38ef0fb686b3092145de0d1c1
% funds come from f2pool and refunds goes back to f2pool again

% I would like to spend some time to make charts from the transactions happening on the date of the Status ICO
% this will include: The blocks mined by F2Pool, containing transactions (~100 ETH) to Status ICO, other blocks mined in that time period, the movement of status tokens from those addresses allegedly linked to F2Pool (or/and Yunbi in this case).
% https://github.com/corpetty/ICO_analysis/blob/master/status/Status.ipynb
% https://github.com/corpetty/py-etherscan-api


%What is Bancor and how it can be frontrun:%

\subsubsection{Bancor} is an Ethereum-based application that allows users to exchange their tokens without any counterparty risk. This protocol aims to solve the cryptocurrency liquidity issue by introducing \textit{Smart Tokens}~\cite{hertzog2017bancor}-- ERC20 compatible tokens with a built-in liquidity mechanism that are always available to users. Smart Tokens can be bought and sold through the users smart contract at an automatically calculated price which displays supply and demand. Doing so, Bancor protocol provides continuous liquidity for digital assets without relying on an orderbook as there is no requirement to match sellers and buyers.

\par\noindent\textbf{Front-running Bancor} Recently, researchers have shown that Bancor is vulnerable to frontrunning attacks. Implemented on the Ethereum blockchain, when Bancor transactions are broadcast to the network, they sit in a pending transaction pool known as \textit{mempool} waiting for the miners to mine them. Since Bancor handles all the trades and exchanges on the Ethereum blockchain (unlike other existing decentralized exchanges), these transactions are all visible to the public for 16s (the average Ethereum blocktime) before being included within a block. This leaves this blockchain-based decentralized exchange vulnerable to the blockchain race condition attack as attackers are given enough time to front-run other transactions and gain favourable profits~\cite{BancorIs7:online}. Bancor frontrunning attacks can occur in two different ways:


\begin{itemize}
\item {\textbf{Miner Frontrunning.}} As mentioned, Bancor protocol uses an algorithm that automatically calculates the price of digital assets to provide better market liquidity. In the Bancor model, essentially buy orders increase the price of the tokens while sell order decrease it. Since the Blockchain miners are the only parties who can decide on the order of transactions within a block, they can easily intercept and reorder the pending transactions sitting in the mempool and profit from a guaranteed price-rise. For example, a miner learns about the pending \textit{buy} transaction of 1000 Ether, based on the Bancor design, if this transaction goes through, it causes the price of Ether to increase. So the dishonest miner can step in front of this transaction and  place his own buy order ahead of it. So he would simply create his \textit{buy} of 1000 Ether and include it within a block and now he mines the previous \textit{buy} transaction of 1000 Ether. Doing so, he would receive a better rate than other Bancor user, can sell the tokens he has received and gain a price advantage at the expense of others. Similarly, a dishonest miner can sell his tokens in front, if he sees a pending \textit{sell} transaction.


\item {\textbf{Non-miner Frontrunning.}} Researchers have also shown that a regular non-miner user can also front-run Bancor. In order for the Bancor transactions to be executed on the Ethereum Virtual Machine (EVM),  users have to pay for the computations in small amount of Ether called \textit{gas}~\cite{AccountT67:online}. The price that users pay for transactions (a.k.a. transaction fees) can increase or decrease how quickly they are executed and included within the blocks by the miners.  This is because the Ethereum miners consume resources to process the transactions and so receive the transaction fees after creating the blocks. Once seeing two identical transactions with different transaction fees, profit maximizers miners are free to mine select the transaction which offers the highest fee. Therefore, any regular non-miner users who run a full-node Ethereum client can modify the order of pending transactions by paying a more amount of gas \ie by monitoring the network, upon seeing a  pending \textit{buy} transaction which will further increase the price of the asset, a font-runner user can pay a higher gas price and send his transaction a head of that. By doing so, he achieves a better rate from any other Bancor users.

\end{itemize}

%Following section talks about frontrunning in namespaces but limited to Ghazal. Will talk about NameCoin in the section of mitigations (commit & reveal method)
\subsubsection{Namespaces} Although frontrunning attacks have been more showcased in the context of decentralized exchanges and trading systems, they are are not yet limited to the financial markets. Frontrunning can occur within other blockchain based applications such as naming systems. Blockchain-based namespaces have been introduced to eliminate the role of central parties \ie domain name system (DNS) which introduces single point of failures in the entire web. One such system is Ghazal, an Ethereum-based naming and PKI system~\cite{moosavighazal}. Ghazal users rely on the Ethereum blockchain to register their \texttt{.ghazal} domain names and bind certificates to those names. In Ghazal model, a user would register domain name by executing the \textit{registerdomain} function from the Ghazal smart contract with the domain name in plain text as the function argument. As mentioned before, These transactions will sit in the mempool so that it would be mined by Ethereum miners and included in the block. During this period in which the transaction is not yet confirmed, frontrunning attack can occur by (i) dishonest miners and/or (ii) regular non-miner user. In the first case, a miner would intercept the \textit{registerdomain} transaction and register that name ahead of the user. A regular non-miner node in the Ethereum network can frontrun other user's \textit{registerdomain} at a good profit by paying higher transaction fees. In both cases the adversarial party could sell the domain name to the users for higher price.



%@ possibility of PoC attack (@shayan @mahsa)
%===========================%

% = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = =
\section{Mitigations}

Commit / reveal methods %namecoin story @mahsa 
% 1) Go dark
\begin{itemize}
\item{Send the hash first, send the actual data after (sealed-bid auctions)}
\item{Proof of burn methods (generate random addresses with no private keys)}
\end{itemize}
Submarines
\begin{itemize}
\item{The method described in HD can be optimized and more functional with the new changes to ethereum and solidity}
\item{Submarines 2.0: There can be a new way of doing this (new WRT hackingditributed article), can predict smart contract addresses using the nonce and data of the contract (forwarder/refunder), so funds can be sent to these addresses and then contracts can be deployed}
\begin {itemize}
\item{Pros: new addresses, no indication of the order (Anonymity-set)}
\item{Cons: DDoS? Requires 3 transactions for each order?} >> 1 send the funds 2 Deploy the contract 3 call the function
\end{itemize}
\item{Other methods? Consensus protocol based solutions?}

\end{itemize}



% How are we solving this in orderbooks?
%shayan: Give the fees in a decental orderbook to the miners so change the incentive model and they are incentivized to act honestly
%2) kill the incentive (change the incentive) ^ .

% also call options on a random ending block, so timing of the incoming transactiion does not matter


%3) change the mechanics. similar to double spend mitigation, fee structure. with gas limits gasprice limit (status ico did. and bancor after the attack)


% = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = =

\section{Concluding Remarks}



% @shayan:
% Could talk about a tool / a framework to detect frontrunning
% Circle in the py-etherscan guy about having the tools to detect such things


%\subsubsection*{Acknowledgements.}
